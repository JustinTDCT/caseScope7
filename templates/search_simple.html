{% extends "base.html" %}

{% block title %}Search Events{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-search"></i> Search Events</h3>
                </div>
                <div class="card-body">
                    <!-- Search Form -->
                    <form method="GET" action="{{ url_for('search') }}" class="mb-4">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control" 
                                           name="query" 
                                           value="{{ query if query else '' }}" 
                                           placeholder="Search events... (e.g., '4625 AND administrator', 'failed logon', Event ID 1149)"
                                           autocomplete="off">
                                    <button class="btn btn-primary" type="submit">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    Use AND, OR operators and "quotes" for phrases. Click field names to add to search.
                                </small>
                            </div>
                            <div class="col-md-4">
                                <select name="case_id" class="form-select">
                                    <option value="{{ case.id }}" selected>{{ case.name }}</option>
                                </select>
                            </div>
                        </div>
                    </form>

                    <!-- Search Results -->
                    {% if query and results %}
                    <div class="results-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Search Results ({{ results|length }} events)</h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportResults()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        
                        <!-- Simple Table View -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="events-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 15%;">Event Date</th>
                                        <th style="width: 10%;">Event ID</th>
                                        <th style="width: 40%;">Summary</th>
                                        <th style="width: 15%;">Computer</th>
                                        <th style="width: 10%;">Violations</th>
                                        <th style="width: 10%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in results %}
                                    <tr class="result-row" data-event-id="{{ loop.index }}">
                                        <td class="event-timestamp">
                                            <small class="text-muted">
                                                {% if result.event_timestamp and result.event_timestamp != result.timestamp %}
                                                    {{ result.event_timestamp[:19] }}
                                                {% else %}
                                                    {{ result.timestamp[:19] }}
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td class="event-id">
                                            <span class="badge bg-primary clickable-field" 
                                                  data-field="event_id" 
                                                  data-value="{{ result.event_id }}">
                                                {{ result.event_id if result.event_id else 'Unknown' }}
                                            </span>
                                        </td>
                                        <td class="event-summary">
                                            <div class="summary-text">
                                                {{ result.event_summary if result.event_summary else 'No summary available' }}
                                            </div>
                                        </td>
                                        <td class="computer-name">
                                            <span class="clickable-field" 
                                                  data-field="computer" 
                                                  data-value="{{ result.computer_name }}">
                                                {{ result.computer_name if result.computer_name else 'Unknown' }}
                                            </span>
                                        </td>
                                        <td class="rule-violations">
                                            {% if result.sigma_violations or result.chainsaw_violations %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-exclamation-triangle"></i> 
                                                    {{ (result.sigma_violations|length) + (result.chainsaw_violations|length) }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="actions">
                                            <button class="btn btn-sm btn-outline-primary toggle-details" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#details-{{ loop.index }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <!-- Collapsible Details Row -->
                                    <tr class="collapse" id="details-{{ loop.index }}">
                                        <td colspan="6" class="details-content p-0">
                                            <div class="card border-0">
                                                <div class="card-body">
                                                    <div class="row">
                                                        <!-- Event Fields -->
                                                        <div class="col-md-8">
                                                            <h6><i class="fas fa-list"></i> Event Details</h6>
                                                            <div class="table-responsive">
                                                                <table class="table table-sm table-bordered">
                                                                    <thead>
                                                                        <tr>
                                                                            <th style="width: 30%;">Field</th>
                                                                            <th style="width: 70%;">Value</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% if result.event_fields and result.event_fields|length > 0 %}
                                                                            {% for field_name, field_value in result.event_fields.items() %}
                                                                                {% if field_value and field_value != '' and field_value != 'None' %}
                                                                                <tr>
                                                                                    <td class="field-name">
                                                                                        <span class="clickable-field fw-bold" 
                                                                                              data-field="{{ field_name }}" 
                                                                                              data-value="{{ field_value }}"
                                                                                              title="Click to add to search">
                                                                                            {{ field_name }}
                                                                                        </span>
                                                                                    </td>
                                                                                    <td class="field-value">
                                                                                        <span class="clickable-field" 
                                                                                              data-field="{{ field_name }}" 
                                                                                              data-value="{{ field_value }}"
                                                                                              title="Click to add to search">
                                                                                            {{ field_value }}
                                                                                        </span>
                                                                                    </td>
                                                                                </tr>
                                                                                {% endif %}
                                                                            {% endfor %}
                                                                        {% else %}
                                                                            <tr>
                                                                                <td colspan="2" class="text-muted">No detailed fields available</td>
                                                                            </tr>
                                                                        {% endif %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Source & Violations -->
                                                        <div class="col-md-4">
                                                            <h6><i class="fas fa-file"></i> Source Information</h6>
                                                            <table class="table table-sm">
                                                                <tr><td><strong>Source File:</strong></td><td>{{ result.source_file }}</td></tr>
                                                                <tr><td><strong>File ID:</strong></td><td>{{ result.file_id }}</td></tr>
                                                                <tr><td><strong>Ingestion:</strong></td><td>{{ result.ingestion_timestamp[:19] if result.ingestion_timestamp else 'N/A' }}</td></tr>
                                                            </table>
                                                            
                                                            {% if result.sigma_violations or result.chainsaw_violations %}
                                                            <h6><i class="fas fa-shield-alt"></i> Rule Violations</h6>
                                                            {% if result.sigma_violations %}
                                                                <div class="alert alert-warning alert-sm">
                                                                    <strong>Sigma Rules:</strong>
                                                                    <ul class="mb-0">
                                                                        {% for violation in result.sigma_violations %}
                                                                        <li>{{ violation }}</li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                </div>
                                                            {% endif %}
                                                            {% if result.chainsaw_violations %}
                                                                <div class="alert alert-danger alert-sm">
                                                                    <strong>Chainsaw Rules:</strong>
                                                                    <ul class="mb-0">
                                                                        {% for violation in result.chainsaw_violations %}
                                                                        <li>{{ violation }}</li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                </div>
                                                            {% endif %}
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% elif query %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No events found matching your search criteria.
                    </div>
                    {% else %}
                    <div class="alert alert-secondary">
                        <i class="fas fa-search"></i> Enter a search query to find events.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.clickable-field {
    cursor: pointer;
    color: #0066cc;
    text-decoration: none;
    border-radius: 3px;
    padding: 1px 3px;
    transition: background-color 0.2s;
}

.clickable-field:hover {
    background-color: #e3f2fd;
    text-decoration: underline;
}

.summary-text {
    font-size: 0.9rem;
    line-height: 1.3;
}

.event-timestamp {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
}

.details-content {
    background-color: #f8f9fa;
}

.alert-sm {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.table th {
    font-weight: 600;
    font-size: 0.9rem;
}

.table td {
    font-size: 0.9rem;
    vertical-align: middle;
}

.field-name {
    background-color: #f1f3f4;
    font-weight: 500;
}
</style>

<script>
// Add field to search when clicked
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.clickable-field').forEach(function(element) {
        element.addEventListener('click', function() {
            const field = this.getAttribute('data-field');
            const value = this.getAttribute('data-value');
            
            if (field && value) {
                const searchInput = document.querySelector('input[name="query"]');
                const currentQuery = searchInput.value.trim();
                
                // Create search term
                let searchTerm = '';
                if (field === 'event_id') {
                    searchTerm = value;
                } else {
                    searchTerm = `${field}:"${value}"`;
                }
                
                // Add to existing query
                if (currentQuery) {
                    searchInput.value = currentQuery + ' AND ' + searchTerm;
                } else {
                    searchInput.value = searchTerm;
                }
                
                // Visual feedback
                this.style.backgroundColor = '#4caf50';
                this.style.color = 'white';
                setTimeout(() => {
                    this.style.backgroundColor = '';
                    this.style.color = '';
                }, 500);
            }
        });
    });
});

function exportResults() {
    // Simple CSV export
    const table = document.getElementById('events-table');
    let csv = 'Event Date,Event ID,Summary,Computer,Violations\n';
    
    table.querySelectorAll('tbody tr.result-row').forEach(function(row) {
        const cells = row.querySelectorAll('td');
        const rowData = [
            cells[0].textContent.trim(),
            cells[1].textContent.trim(),
            cells[2].textContent.trim().replace(/"/g, '""'),
            cells[3].textContent.trim(),
            cells[4].textContent.trim()
        ];
        csv += '"' + rowData.join('","') + '"\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'search_results.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}

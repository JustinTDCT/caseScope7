{% extends "base.html" %}

{% block title %}SIGMA Violations - caseScope{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-exclamation-triangle"></i> SIGMA Violations - {{ case.name }}</h1>
</div>

<!-- Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-list"></i></div>
        <div class="stat-details">
            <div class="stat-value">{{ total_violations }}</div>
            <div class="stat-label">Total</div>
        </div>
    </div>
    <div class="stat-card critical">
        <div class="stat-icon"><i class="fas fa-skull-crossbones"></i></div>
        <div class="stat-details">
            <div class="stat-value">{{ critical_count }}</div>
            <div class="stat-label">Critical</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-exclamation"></i></div>
        <div class="stat-details">
            <div class="stat-value">{{ high_count }}</div>
            <div class="stat-label">High</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-info-circle"></i></div>
        <div class="stat-details">
            <div class="stat-value">{{ medium_count }}</div>
            <div class="stat-label">Medium</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-check"></i></div>
        <div class="stat-details">
            <div class="stat-value">{{ low_count }}</div>
            <div class="stat-label">Low</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-user-check"></i></div>
        <div class="stat-details">
            <div class="stat-value">{{ reviewed_count }}</div>
            <div class="stat-label">Reviewed</div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card">
    <h3><i class="fas fa-filter"></i> Filters</h3>
    <div class="filters">
        <select onchange="window.location.href='?severity='+this.value+'&rule={{ rule_filter }}&file={{ file_filter }}&reviewed={{ reviewed_filter }}'">
            <option value="all" {% if severity_filter == 'all' %}selected{% endif %}>All Severities</option>
            <option value="critical" {% if severity_filter == 'critical' %}selected{% endif %}>Critical</option>
            <option value="high" {% if severity_filter == 'high' %}selected{% endif %}>High</option>
            <option value="medium" {% if severity_filter == 'medium' %}selected{% endif %}>Medium</option>
            <option value="low" {% if severity_filter == 'low' %}selected{% endif %}>Low</option>
        </select>
        
        <select onchange="window.location.href='?severity={{ severity_filter }}&rule='+this.value+'&file={{ file_filter }}&reviewed={{ reviewed_filter }}'">
            <option value="all" {% if rule_filter == 'all' %}selected{% endif %}>All Rules</option>
            {% for rule in all_rules %}
            <option value="{{ rule.id }}" {% if rule_filter|string == rule.id|string %}selected{% endif %}>{{ rule.title }}</option>
            {% endfor %}
        </select>
        
        <select onchange="window.location.href='?severity={{ severity_filter }}&rule={{ rule_filter }}&file='+this.value+'&reviewed={{ reviewed_filter }}'">
            <option value="all" {% if file_filter == 'all' %}selected{% endif %}>All Files</option>
            {% for file in all_files %}
            <option value="{{ file.id }}" {% if file_filter|string == file.id|string %}selected{% endif %}>{{ file.original_filename }}</option>
            {% endfor %}
        </select>
        
        <select onchange="window.location.href='?severity={{ severity_filter }}&rule={{ rule_filter }}&file={{ file_filter }}&reviewed='+this.value">
            <option value="all" {% if reviewed_filter == 'all' %}selected{% endif %}>All Status</option>
            <option value="unreviewed" {% if reviewed_filter == 'unreviewed' %}selected{% endif %}>Unreviewed</option>
            <option value="reviewed" {% if reviewed_filter == 'reviewed' %}selected{% endif %}>Reviewed</option>
        </select>
    </div>
</div>

<!-- Violations Table -->
<div class="card">
    <h3><i class="fas fa-list"></i> Violations</h3>
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Severity</th>
                    <th>Rule</th>
                    <th>File</th>
                    <th>Event ID</th>
                    <th>Computer</th>
                    <th>Timestamp</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if violations %}
                    {% for v in violations %}
                    {% set event_data = v.event_data|from_json %}
                    {% set event_id = event_data.get('System', {}).get('EventID', {}).get('#text', 'N/A') %}
                    {% set computer = event_data.get('System', {}).get('Computer', 'N/A') %}
                    {% set timestamp = event_data.get('System', {}).get('TimeCreated', {}).get('@SystemTime', 'N/A') %}
                    <tr>
                        <td><span class="badge badge-{{ v.severity }}">{{ v.severity|upper }}</span></td>
                        <td>{{ v.rule.title }}</td>
                        <td>{{ v.file.original_filename }}</td>
                        <td>{{ event_id }}</td>
                        <td>{{ computer }}</td>
                        <td>{{ timestamp[:19] if timestamp != 'N/A' else 'N/A' }}</td>
                        <td>
                            {% if v.is_reviewed %}
                            <span class="badge badge-success">Reviewed</span>
                            {% else %}
                            <span class="badge badge-warning">Pending</span>
                            {% endif %}
                        </td>
                        <td class="actions">
                            <button class="btn-icon" onclick="viewViolation({{ v.id }})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if not v.is_reviewed %}
                            <button class="btn-icon" onclick="reviewViolation({{ v.id }})" title="Mark Reviewed">
                                <i class="fas fa-check"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    <tr id="violation-details-{{ v.id }}" class="rule-details" style="display: none;">
                        <td colspan="8">
                            <div class="violation-details-panel">
                                <h4>Violation Details</h4>
                                <div class="detail-grid">
                                    <div><strong>Rule:</strong> {{ v.rule.title }}</div>
                                    <div><strong>Description:</strong> {{ v.rule.description }}</div>
                                    <div><strong>Severity:</strong> <span class="badge badge-{{ v.severity }}">{{ v.severity|upper }}</span></div>
                                    <div><strong>Detected:</strong> {{ v.detected_at.strftime('%Y-%m-%d %H:%M:%S') if v.detected_at else 'N/A' }}</div>
                                    {% if v.is_reviewed %}
                                    <div><strong>Reviewed By:</strong> {{ v.reviewer.username if v.reviewer else 'N/A' }}</div>
                                    <div><strong>Review Date:</strong> {{ v.reviewed_at.strftime('%Y-%m-%d %H:%M:%S') if v.reviewed_at else 'N/A' }}</div>
                                    {% if v.notes %}
                                    <div style="grid-column: 1 / -1;"><strong>Notes:</strong><br>{{ v.notes }}</div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                <h4>Event Data</h4>
                                <pre class="event-json">{{ event_data|tojson(indent=2) }}</pre>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center">No violations found with current filters.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
    <a href="?page={{ page-1 }}&severity={{ severity_filter }}&rule={{ rule_filter }}&file={{ file_filter }}&reviewed={{ reviewed_filter }}" class="btn">← Previous</a>
    {% endif %}
    <span>Page {{ page }} of {{ total_pages }}</span>
    {% if page < total_pages %}
    <a href="?page={{ page+1 }}&severity={{ severity_filter }}&rule={{ rule_filter }}&file={{ file_filter }}&reviewed={{ reviewed_filter }}" class="btn">Next →</a>
    {% endif %}
</div>
{% endif %}

<script>
function viewViolation(violationId) {
    const row = document.getElementById('violation-details-' + violationId);
    if (row.style.display === 'none') {
        row.style.display = 'table-row';
    } else {
        row.style.display = 'none';
    }
}

function reviewViolation(violationId) {
    const notes = prompt('Add review notes (optional):');
    if (notes !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/violation/' + violationId + '/review';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'notes';
        input.value = notes;
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}{{ case.name }} - caseScope{% endblock %}

{% block content %}
<div class="case-dashboard-container">
    <div class="case-header">
        <div class="case-info">
            <h1>{{ case.name }}</h1>
            <div class="case-meta">
                <div class="meta-item">
                    <i class="fas fa-calendar"></i>
                    <span>Created {{ case.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-user"></i>
                    <span>by {{ case.creator.username }}</span>
                </div>
                {% if case.description %}
                <div class="meta-item description">
                    <i class="fas fa-info-circle"></i>
                    <span>{{ case.description }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="case-actions">
            <a href="{{ url_for('deselect_case') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to System
            </a>
            <a href="{{ url_for('upload_files') }}" class="btn btn-primary">
                <i class="fas fa-upload"></i>
                Upload Files
            </a>
        </div>
    </div>

    <!-- Case Statistics -->
    <div class="grid grid-cols-4 mb-4">
        <div class="stat-card clickable" onclick="window.location.href='{{ url_for('list_files') }}'">
            <div class="stat-icon primary">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ file_count }}</div>
                <div class="stat-label">Files Ingested</div>
                <div class="stat-subtitle">Click to view details</div>
            </div>
        </div>

        <div class="stat-card clickable" onclick="searchViolations('sigma')">
            <div class="stat-icon danger">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ sigma_violations }}</div>
                <div class="stat-label">Sigma Rule Violations</div>
                <div class="stat-subtitle">Click to search OpenSearch</div>
            </div>
        </div>

        <div class="stat-card clickable" onclick="searchViolations('chainsaw')">
            <div class="stat-icon warning">
                <i class="fas fa-link"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ chainsaw_violations }}</div>
                <div class="stat-label">Chainsaw Rule Violations</div>
                <div class="stat-subtitle">Click to search OpenSearch</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ workers|length }}</div>
                <div class="stat-label">Active Contributors</div>
                <div class="stat-subtitle">Users who added content</div>
            </div>
        </div>
    </div>

    <!-- Case Workers and Activity -->
    <div class="grid grid-cols-2 mb-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users"></i>
                    Case Contributors
                </h3>
            </div>
            <div class="card-content">
                {% if workers %}
                <div class="worker-list">
                    {% for worker in workers %}
                    <div class="worker-item">
                        <div class="worker-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="worker-info">
                            <div class="worker-name">{{ worker.username }}</div>
                            <div class="worker-role">{{ worker.role.title() }}</div>
                        </div>
                        <div class="worker-stats">
                            <div class="stat">
                                <span class="stat-number">{{ worker.file_count if worker.file_count is defined else 0 }}</span>
                                <span class="stat-label">Files</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-user-plus"></i>
                    <p>No contributors yet. Upload files to start contributing to this case.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Processing Status
                </h3>
            </div>
            <div class="card-content">
                <div class="processing-overview">
                    <div class="processing-stat">
                        <div class="stat-circle completed">
                            <span class="stat-number" id="completed-files">0</span>
                        </div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="processing-stat">
                        <div class="stat-circle processing">
                            <span class="stat-number" id="processing-files">0</span>
                        </div>
                        <div class="stat-label">Processing</div>
                    </div>
                    <div class="processing-stat">
                        <div class="stat-circle pending">
                            <span class="stat-number" id="pending-files">0</span>
                        </div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="processing-stat">
                        <div class="stat-circle error">
                            <span class="stat-number" id="error-files">0</span>
                        </div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Files -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-file-alt"></i>
                Recent Files
            </h3>
            <div class="card-actions">
                <a href="{{ url_for('list_files') }}" class="btn btn-secondary">
                    <i class="fas fa-list"></i>
                    View All Files
                </a>
                <a href="{{ url_for('upload_files') }}" class="btn btn-primary">
                    <i class="fas fa-upload"></i>
                    Upload Files
                </a>
            </div>
        </div>
        <div class="card-content">
            {% if case.files.count() > 0 %}
            <div class="file-list">
                {% for file in case.files.order_by(case.files.property.mapper.class_.uploaded_at.desc()).limit(5) %}
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">{{ file.original_filename }}</div>
                            <div class="file-meta">
                                <span class="file-size">{{ (file.file_size / 1024 / 1024)|round(2) }} MB</span>
                                <span class="file-date">{{ file.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                <span class="file-uploader">by {{ file.uploader.username }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="file-status">
                        <span class="badge badge-{{ 'success' if file.processing_status == 'completed' else 'warning' if file.processing_status == 'processing' else 'danger' if file.processing_status == 'error' else 'secondary' }}">
                            {{ file.processing_status.title() }}
                        </span>
                        {% if file.processing_status == 'processing' %}
                        <div class="progress mt-2">
                            <div class="progress-bar" style="width: {{ file.processing_progress }}%"></div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="file-stats">
                        {% if file.event_count > 0 %}
                        <div class="file-stat">
                            <span class="stat-number">{{ file.event_count }}</span>
                            <span class="stat-label">Events</span>
                        </div>
                        {% endif %}
                        {% if file.sigma_violations > 0 %}
                        <div class="file-stat violation">
                            <span class="stat-number">{{ file.sigma_violations }}</span>
                            <span class="stat-label">Sigma</span>
                        </div>
                        {% endif %}
                        {% if file.chainsaw_violations > 0 %}
                        <div class="file-stat violation">
                            <span class="stat-number">{{ file.chainsaw_violations }}</span>
                            <span class="stat-label">Chainsaw</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-file-upload"></i>
                <h4>No Files Uploaded</h4>
                <p>Upload EVTX files to start analyzing events in this case.</p>
                <a href="{{ url_for('upload_files') }}" class="btn btn-primary">
                    <i class="fas fa-upload"></i>
                    Upload First File
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.case-dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
}

.case-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
}

.case-info h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 1rem 0;
}

.case-meta {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.meta-item i {
    width: 16px;
    color: var(--primary-color);
}

.meta-item.description {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
}

.meta-item.description span {
    color: var(--text-primary);
    font-style: italic;
}

.case-actions {
    display: flex;
    gap: 1rem;
    flex-shrink: 0;
}

.stat-card.clickable {
    cursor: pointer;
    transition: all 0.3s ease;
}

.stat-card.clickable:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

.stat-subtitle {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.worker-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.worker-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.worker-avatar {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    font-size: 1.2rem;
}

.worker-info {
    flex: 1;
}

.worker-name {
    font-weight: 600;
    color: var(--text-primary);
}

.worker-role {
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-transform: capitalize;
}

.worker-stats {
    display: flex;
    gap: 1rem;
}

.worker-stats .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.worker-stats .stat-number {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.worker-stats .stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.processing-overview {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 2rem;
}

.processing-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 0.5rem;
}

.stat-circle {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
}

.stat-circle.completed {
    background: var(--success-color);
}

.stat-circle.processing {
    background: var(--primary-color);
}

.stat-circle.pending {
    background: var(--warning-color);
    color: #2d3748;
}

.stat-circle.error {
    background: var(--error-color);
}

.file-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.file-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.file-item:hover {
    background: var(--bg-tertiary);
    transform: translateY(-2px);
}

.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.file-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(66, 153, 225, 0.2);
    color: var(--primary-color);
    border-radius: 12px;
    font-size: 1.5rem;
}

.file-details {
    flex: 1;
}

.file-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.file-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.file-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    min-width: 120px;
}

.file-stats {
    display: flex;
    gap: 1rem;
}

.file-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 0.5rem;
    background: var(--bg-primary);
    border-radius: 8px;
    min-width: 60px;
}

.file-stat.violation {
    background: rgba(252, 129, 129, 0.1);
    border: 1px solid var(--error-color);
}

.file-stat .stat-number {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
}

.file-stat.violation .stat-number {
    color: var(--error-color);
}

.file-stat .stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.card-actions {
    display: flex;
    gap: 1rem;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: var(--text-muted);
}

.empty-state h4 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.empty-state p {
    margin-bottom: 2rem;
}

@media (max-width: 768px) {
    .case-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .case-actions {
        justify-content: center;
    }
    
    .grid-cols-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    
    .processing-overview {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .file-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .file-stats {
        align-self: stretch;
        justify-content: space-around;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function searchViolations(ruleType) {
    const caseId = {{ case.id }};
    const searchUrl = `{{ url_for('search') }}?rule_type=${ruleType}&case_id=${caseId}`;
    window.location.href = searchUrl;
    debugLog(`Searching ${ruleType} violations for case ${caseId}`);
}

function updateProcessingStats() {
    // This would typically fetch real-time processing statistics
    const caseId = {{ case.id }};
    
    fetch(`/api/case/${caseId}/processing-stats`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('completed-files').textContent = data.completed || 0;
            document.getElementById('processing-files').textContent = data.processing || 0;
            document.getElementById('pending-files').textContent = data.pending || 0;
            document.getElementById('error-files').textContent = data.error || 0;
        })
        .catch(error => {
            debugLog('Error loading processing stats: ' + error.message);
        });
}

// Update processing stats every 10 seconds
setInterval(updateProcessingStats, 10000);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateProcessingStats();
});
</script>
{% endblock %}


# v9.5.0 Modular Architecture Implementation Plan

## Status: üöß IN PROGRESS (30% complete)

## User Requirements:
"Make it modular which we should have done from the start"

### Modular Functions (4 standalone):
1. ‚úÖ `duplicate_check()` - Hash + filename matching
2. ‚úÖ `index_file()` - EVTX‚ÜíJSON‚ÜíOpenSearch
3. ‚úÖ `chainsaw_file()` - SIGMA rule matching
4. ‚úÖ `hunt_iocs()` - IOC detection (grep-like)

### Worker Stack (sequential):
‚úÖ duplicate_check ‚Üí index_file ‚Üí chainsaw_file ‚Üí hunt_iocs
- Each worker processes ONE file completely
- 2 workers run in parallel
- File 1 (Worker 1) and File 2 (Worker 2) process simultaneously

### Upload Process:
- [ ] Decompress ALL ZIP files first
- [ ] Queue all files for processing
- [ ] 2 workers process files (each does full stack)

### Single File Operations:
‚úÖ Reindex: Clear all ‚Üí index_file ‚Üí chainsaw_file ‚Üí hunt_iocs
‚úÖ Rechainsaw: Clear SIGMA ‚Üí chainsaw_file
‚úÖ Rehunt: Clear IOC ‚Üí hunt_iocs

### Bulk Operations (TODO):
- [ ] Bulk Reindex: Clear all case data ‚Üí run full stack on each file
- [ ] Bulk Rechainsaw: Clear all SIGMA ‚Üí run chainsaw on each file
- [ ] Bulk Rehunt: Clear all IOC ‚Üí run hunt_iocs on each file

---

## ‚úÖ Completed (v9.5.0-alpha):

### 1. New File: `file_processing.py` (500+ lines)
- `duplicate_check()` - Checks hash + filename, logs skipped files
- `index_file()` - Converts EVTX, counts events, indexes to OpenSearch
- `chainsaw_file()` - Placeholder for SIGMA (needs implementation)
- `hunt_iocs()` - Grep-like IOC search (case-insensitive)

### 2. New Task: `tasks.process_file_v9()`
- Modular worker using 4 functions
- Supports operations: 'full', 'reindex', 'chainsaw_only', 'ioc_only'
- Clean error handling
- Progress tracking via Celery

### 3. Architecture Benefits:
- ‚úÖ Each function is standalone (can be called individually)
- ‚úÖ No code duplication
- ‚úÖ Consistent behavior (all operations use same functions)
- ‚úÖ Easy to test and debug
- ‚úÖ Clear separation of concerns

---

## üöß TODO (Remaining 70%):

### Phase 1: Switch to v9.5.0 Task (CRITICAL)
- [ ] Update `main.py` upload routes to call `process_file_v9.delay()` instead of `process_file_complete.delay()`
- [ ] Update `local_uploads.py` to use v9.5.0 task
- [ ] Update file-management buttons (reindex, rechainsaw, rehunt) to use v9.5.0 operations

### Phase 2: Implement SIGMA Processing
- [ ] Complete `chainsaw_file()` function (currently placeholder)
- [ ] Port SIGMA matching logic from old code
- [ ] Test SIGMA rule processing

### Phase 3: Bulk Operations
- [ ] Create `bulk_reindex_case()` task
- [ ] Create `bulk_rechainsaw_case()` task
- [ ] Create `bulk_rehunt_case()` task
- [ ] Update UI buttons to call new tasks

### Phase 4: Upload Process Refactoring
- [ ] Implement "decompress ALL ZIPs first" logic
- [ ] Update local upload to extract all before queuing
- [ ] Update HTTP upload to extract all before queuing

### Phase 5: Testing & Migration
- [ ] Test single file upload
- [ ] Test ZIP upload (multiple files)
- [ ] Test local bulk upload
- [ ] Test single file operations (reindex, rechainsaw, rehunt)
- [ ] Test bulk operations
- [ ] Deprecate `process_file_complete()` (v8.0)
- [ ] Remove old code after testing

---

## Deployment Strategy:

### Option A: Gradual Migration (RECOMMENDED)
1. Deploy v9.5.0-alpha with BOTH tasks (v9.5.0 + v8.0)
2. Test v9.5.0 on new uploads
3. Keep v8.0 as fallback
4. After successful testing, switch all operations to v9.5.0
5. Remove v8.0 task

### Option B: Big Bang (RISKY)
1. Complete ALL phases
2. Deploy v9.5.0 (remove v8.0)
3. Test everything at once

**Recommendation**: Use Option A

---

## Current Status:

**File**: `file_processing.py` (NEW)
- ‚úÖ All 4 functions implemented
- ‚ö†Ô∏è  SIGMA function is placeholder (needs porting)

**File**: `tasks.py`
- ‚úÖ `process_file_v9()` task added (lines 3426-3734)
- ‚úÖ `process_file_complete()` marked as deprecated
- ‚ö†Ô∏è  NOT YET BEING CALLED (still using old task)

**File**: `main.py`
- ‚ö†Ô∏è  Still calls `process_file_complete.delay()`
- ‚ö†Ô∏è  Needs update to call `process_file_v9.delay()`

**File**: `local_uploads.py`
- ‚ö†Ô∏è  Still uses old task
- ‚ö†Ô∏è  Needs update

---

## Next Steps:

1. **Review this plan** - Does it match your requirements?
2. **Decide deployment strategy** - Gradual or Big Bang?
3. **Continue implementation** - Phase 1 (switch tasks)

---

## User Feedback Needed:

1. Is the modular architecture correct?
2. Should we deploy alpha version for testing or complete all phases first?
3. Any changes to the 4 functions or worker stack?

---

End of Implementation Plan
